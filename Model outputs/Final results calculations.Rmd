---
title: "Updated data"
author: "Allie Bauman"
date: '2023-01-29'
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Use potato and beef data to get change in assets from the baseline for all scenarios

We want the following data: 

1. Potatoes change from the baseline - for all scenarios
  + For DPS regular and DPSx1000 scenarios
  + at the farm level and at the DPS level
  + have financial and environmental results in the same table
  + a figure at the farm level
  + a figure at the DPS level
  
2. Repeat for beef
  + There is no DPSx1000 scenario for beef
  
The potato scenarios include baseline, fresh, gfpp, small, and specialty and the beef scenarios include baseline and Colorado source. Results are for all sub-groups (i.e., all organic, some organic...) aggregated, none of the results are split out by sub groups. 

## Import data 
All data has a different csv file for each scenario. We import all potato data into one file and same with beef and only keep the variables of interest, adding a column that indicates the scenario.   

```{r}
# Import data
library(tidyverse)
library(janitor)

# Read in all files to create one tibble, adding the name of the scenario as a new variable, select only variables of interest. Beef and potato are two separate tibbles. 

# Beef
data_path <- "data/beef"
files <- dir(data_path, pattern = "*.csv")

beef <- data_frame(scenario = files) %>% 
  mutate(file_contents = map(scenario, 
                             ~ read_csv(file.path(data_path, .), 
                                         skip = 6, show_col_types = FALSE))) %>%
  unnest() %>% clean_names() %>% select(
    scenario,
    mean_assets_change_of_beef_ranchers, 
    mean_assets_change_of_dps_buyers, 
    beef_co2_kg_eq_at_denver_model_run, 
    beef_co2_kg_eq_at_farm_model_run,
    beef_h2o_m3_at_denver_model_run,
    beef_h2o_m3_at_farm_model_run) 

# Keep scenario information only from filename
beef <- beef %>% mutate(
  scenario = str_remove(scenario,"FFAR_ABMmodel_umbrella beef_"),
  scenario = str_remove(scenario, "-table_Jan_26_2023.csv")) 

# Potato 
data_path <- "data/potato_new"
files <- dir(data_path, pattern = "*.csv")

potato <- data_frame(scenario = files) %>% 
  mutate(data = map(scenario, 
                             ~ read_csv(file.path(data_path, .), 
                                         skip = 6, show_col_types = FALSE))) %>%  
  mutate(data = map(data, ~select(., "DPS_x1000?",
                                  "mean [assets-change] of potato_farmers",
                                  "mean [assets-change] of dps_buyers",
                                  "potato_CO2-kg-eq-at-farm-model-run",
                                  "potato_CO2-kg-eq-at-Denver-model-run", 
                                  "potato_h2o-m3-at-farm-model-run", 
                                  "potato_h2o-m3-at-Denver-model-run"))) %>% 
  unnest() %>% clean_names()

# Keep scenario information only from filename
# Columns selected before unnesting because differences in variables across scenarios didn't allow for unnesting the whole dataframe as columns must match
potato <- potato %>% mutate(
  scenario = str_remove(scenario,"FFAR_ABMmodel_umbrella potatoes_"),
  scenario = str_remove(scenario, "_x1000_for_DPS-table.csv")) %>% 
  select(scenario, dps_x1000, everything()) 
```

## Define mean change in assets for each scenario
Calculate the mean of the mean_asset_change for the baseline scenario, and subtract this number from each observation in the other scenarios. So the same number is subtracted from each observation. Because the baseline scenario is not paired with the subsequent scenarios, there is not need to do this calculation observation by observation. 
  
Mean change in assets: 
(mean farmer asset change for all farmers in a specific model run â€“ mean asset change all farmers all runs baseline) / mean asset change all farmers all runs baseline.
  

### Potato 

```{r}
potato_baseline <- potato %>% filter(scenario == "baseline") %>% group_by(
  dps_x1000) %>% summarise(across(starts_with(c("mean", "potato")), 
                                  ~mean(.x))) %>% pivot_longer(
                                    !dps_x1000, 
                                    values_to = "mean_baseline", 
                                    names_to = "variable") 

# Create a nested data frame with data separated by scenario, dpsx100 and variable name
potato_sum <- potato %>% pivot_longer(
  cols = !c(scenario, dps_x1000)) %>% arrange(name) %>% 
  group_by(scenario, dps_x1000, name) %>% nest()

# Pivot data so that scenarios are across the top and each observation has all the data for that grouping
potato_sum <- potato_sum  %>% pivot_wider(
  names_from = scenario, 
  values_from = data) %>% rename(
    fresh = `fresh-CO`,
    small = `small-potatoes`,
    specialty = `specialty-product`)

potato_sum <- unnest(potato_sum) %>% rename(
  baseline = value, 
  fresh = value1, 
  gfpp = value2,
  small = value3, 
  specialty = value4, 
  variable = name)
  
# Create new variables that are the percent change in profit, based on subtracting the mean baseline from each scenario, where the mean from the baseline is the same for all observations (this is the way Erin did it)
potato_sum <- potato_sum %>% left_join(potato_baseline)

potato_sum <- potato_sum %>% mutate(
  fresh_percent_change = ((fresh - mean_baseline)/mean_baseline), 
  gfpp_percent_change = ((gfpp - mean_baseline)/mean_baseline), 
  small_percent_change = ((small - mean_baseline)/mean_baseline), 
  specialty_percent_change = ((specialty - mean_baseline)/mean_baseline))

# Get Mean and SD 
potato_sum <- potato_sum %>% group_by(dps_x1000, variable) %>% 
  summarise(across(everything(),
                   list(mean = mean, sd = sd), 
                   .names = "{fn}_{col}")) %>% pivot_longer(
                cols = !c(dps_x1000, variable)) %>% mutate(
                  statistic = case_when(
                    str_detect(name, "^mean") ~ "mean", 
                    str_detect(name, "^sd") ~ "sd"),
                  scenario = str_remove(name, "^mean_"), 
                  scenario = str_remove(scenario, "^sd_")) %>%
  select(-name) %>% pivot_wider(
    names_from = scenario, 
    values_from = value) %>% select(!mean_baseline)

write_csv(potato_sum, "1.29.23_results/potato_sum.csv")
```

### Beef 

```{r}

beef_baseline <- beef %>% filter(scenario == "baseline") %>% summarise(across(starts_with(c("mean", "beef")), 
                                  ~mean(.x))) %>% pivot_longer(
                                    everything(), 
                                    values_to = "mean_baseline", 
                                    names_to = "variable") 

# Create a nested data frame with data separated by scenario, dpsx100 and variable name
beef_sum <- beef %>% pivot_longer(
  cols = !scenario) %>% arrange(name) %>% 
  group_by(scenario, name) %>% nest()

# Pivot data so that scenarios are across the top and each observation has all the data for that grouping
beef_sum <- beef_sum  %>% pivot_wider(
  names_from = scenario, 
  values_from = data) 

beef_sum <- unnest(beef_sum) %>% rename(
  baseline = value, 
  colorado_source = value1, 
  variable = name)

# Create new variables that are the percent change in profit, based on subtracting the mean baseline from each scenario, where the mean from the baseline is the same for all observations (this is the way Erin did it)
beef_sum <- beef_sum %>% left_join(beef_baseline)

beef_sum <- beef_sum %>% mutate(
  colorado_source_percent_change = ((colorado_source - mean_baseline)/mean_baseline))

# Get Mean and SD 
beef_sum <- beef_sum %>% group_by(variable) %>% 
  summarise(across(everything(),
                   list(mean = mean, sd = sd), 
                   .names = "{fn}_{col}")) %>% pivot_longer(
                cols = !c(variable)) %>% mutate(
                  statistic = case_when(
                    str_detect(name, "^mean") ~ "mean", 
                    str_detect(name, "^sd") ~ "sd"),
                  scenario = str_remove(name, "^mean_"), 
                  scenario = str_remove(scenario, "^sd_")) %>%
  select(-name) %>% pivot_wider(
    names_from = scenario, 
    values_from = value) %>% select(!mean_baseline)

write_csv(beef_sum, "1.29.23_results/beef_sum.csv")
```
